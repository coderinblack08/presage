rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow write: if request.auth.uid == userId && !exists(/databases/$(database)/documents/usernames/$(request.resource.data.username));
      allow read: if true;
    }
    
    match /journals/{journalId} {
      allow write: if willBeOwner();
      allow read: if true;
    }

    match /emails/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    match /usernames/{username} {
      allow write: if request.auth.uid == request.resource.data.uid;
      allow read: if true;
    }

    function validateArticleFields() {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(["editorHTML"]);
    }

    match /articles/{articleId} {
      allow create: if willBeOwner() && validateArticleFields();
      allow update: if isOwner() && validateArticleFields();
      allow delete: if isOwner();
      allow read: if isOwner() || resource.data.isPublished == true;
    }

    match /rewards/{rewardId} {
      allow write: if willBeOwner() && (request.resource.data.type in ["Form", "Shoutout", "Message"]);
      allow read: if true;
    }

    match /reward_messages/{id} {
      allow write: if willBeOwner() && exists(/databases/$(database)/documents/rewards/$(id));
      allow read: if false;
    }
  }
}

function isUser(uid) {
  return isSignedIn() && request.auth.uid == uid;
}

function isSignedIn() {
  return request.auth.uid != null;
}

function isOwner(){
  return isUser(currentData().userId);
}

function willBeOwner(){
  return isUser(incomingData().userId);
}

function currentData() {
  return resource.data;
}

function incomingData() {
  return request.resource.data;
}
